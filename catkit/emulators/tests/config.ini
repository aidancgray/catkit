; All paths and configurable strings should be added to this config file.
; Requires the ExtendedInterpolation option of Python's configparser.
; Please use the semi-colon for commenting

[optics_lab]
calibration_data_package = hicat
data_path = hicat_data/
; If on HiCAT-PC use the following prefix, "~/" (aka "home") otherwise.
HiCAT_prefix = C:/Users/HICAT

; Below are the paths to the SAME central store dir containing the copy of C:/Users/HICAT/hicat_data
; I.e.
; Z:/Testbeds/hicat_dev/data/
; /astro/opticslab1/Testbeds/hicat_dev/data/
HiCAT_central_store_prefix = Z:
linux_central_store_prefix = /astro/opticslab1/
central_store_data = Testbeds/hicat_dev/data/

HiCAT_hostname = HiCATdeux

master_logfile_name = HICAT_master.log
master_logfile_level = logging.WARNING
experiment_logfile_level = logging.INFO
console_logfile_level = logging.INFO
slack_webhook = https://hooks.slack.com/services/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
slack_logfile_level = logging.ERROR

; Mathematica scripts (make sure to add your Mathematica install directory to PATH).
wolfram_path =  WolframScript
pipeline_path = mathematica/scripts/data_pipeline/pipeline.wl
simulator_path_1dm = mathematica/scripts/simulator/hicat_sim_1dm.wl
simulator_path_2dm = mathematica/scripts/simulator/hicat_sim_2dm.wl
speckle_sensing_path = mathematica/scripts/speckle_nulling/speckle_sensing.wl
speckle_control_phase_path = mathematica/scripts/speckle_nulling/speckle_control_phase.wl
speckle_control_amplitude_path = mathematica/scripts/speckle_nulling/speckle_control_amplitude.wl
mtf_path = mathematica/scripts/mtf_sampling/sampling.wl

[zwo_ASI1600MM]
camera_name = ZWO ASI1600MM
gain = 0
filename = probe_single_image.fit
exposure_time_us = 30000
bins = 1
subarray_x = 1744
subarray_y = 1193
camera_chip_rotation = 180
camera_chip_fliplr = false
full_image = false
image_rotation = 0
image_fliplr = false
max_counts = 45000
min_counts = 40000
sampling = 7.7574

; Must be a multiple of 8
width = 1856
height = 1856

[zwo_ASI290MM_1]
camera_name = ZWO ASI290MM(1)
gain = 139
bins = 1
subarray_x = 968
subarray_y = 548
camera_chip_rotation = 0
camera_chip_fliplr = false
full_image = false
image_rotation = 0
image_fliplr = false

; Must be a multiple of 8
width = 464
height = 464

[zwo_ASI178MM_3]
camera_name = ZWO ASI178MM(3)
gain = 0
bins = 1
subarray_x = 1744
subarray_y = 1206
camera_chip_rotation = 180
camera_chip_fliplr = false
full_image = false
image_rotation = 0
image_fliplr = false
max_counts = 50000
min_counts = 45000

; Must be a multiple of 8
width = 712
height = 712

; binning of images post calibration (also used by simulator)
binning_calibrated_images = 4

[zwo_ASI178MM_4]
camera_name = ZWO ASI178MM(4)
gain = 0
bins = 1
subarray_x = 1808
subarray_y = 993
camera_chip_rotation = 0
camera_chip_fliplr = false
full_image = true
image_rotation = 0
image_fliplr = false
max_counts = 45000
min_counts = 40000

; Must be a multiple of 8
width = 1856
height = 1856

[boston_kilo952]
; TODO: is this the serial number of the electronics (single box) or one of the dms?
serial_num = 25CW018#008
command_length = 2048
dac_bit_width = 14
max_volts = 200
bias_volts_dm1 = 140
bias_volts_dm2 = 140
flat_map_dm1 = flat_map_volts_dm1_2020-02-19T13-04-36.fits
flat_map_dm2 = flat_map_volts_dm2.fits
gain_map_dm1 = gain_map_dm1_140V_2020-03-02T16-29-41.fits
gain_map_dm2 = gain_map_dm2_140V_2020-03-02T16-29-52.fits
number_of_actuators = 952
; ideal amplitude for poke patterns in nanometers, for best visibility in pupil image
dm1_ideal_poke = 200
dm2_ideal_poke = -150
; distance between DM1 and DM2, in meters:
distance_between_dms = 0.3
; translations of DM2 relative to DM1, also in meters:
dm2_translation_x = -0.000007
dm2_translation_y = 0.000025
; translation of both DMs as a block with respect to the apodizer, also in meters:
both_dms_to_apodizer_translation_x = 0.0
both_dms_to_apodizer_translation_y = 0.0
; DM diameter in mm
diameter_dm_mm = 9.9
; total reflective area is  at least 40 actuators across; see https://jira.stsci.edu/browse/HICAT-347
diameter_dm_reflective_mm = 12.0

dm_length_actuators = 34
; initial estimates for diameters below based on the excel spreadsheet HiCAT_APLCSP_spreadsheet.xlsx
; they are calibrated from plate scale.
; with apodizer in place, as previously everything done in equivalent aperture

; Parameters for optic inclinations. Values estimated from sims matched to 2019-07-25 sine test data
dm1_inclination = 0
dm2_inclination = 0

; Below calibrated values from data.  This needs to be improved to map to the hardware: which pupil? which apod? etc.
; Need to add measurement uncertainties, since these are just numbers spit out by the WL script and we are actually
; not this precise. Note: this is done on purpose for tracking purposes
; pupil_actuator_spaces refers to the entrance pupil of the system; in calssical Lyot mode that will be the pupil mask,
; in APLC mode that will be the apodizer.
dm_actuator_spaces = 33
iris_ao_actuator_spaces = 29.797
pupil_actuator_spaces = 29.2759
apodizer_actuator_spaces = 29.1395
lyotstop_actuator_spaces = 23.5988

; diameter in mm of the boston DM at the Lyot plane:
boston_dm1_diameter_at_lyot_plane = 22.22

[iris_dm]
; Parameters for optic inclinations. Value estimated roughly from optical layout diagram
iris_dm_inclination = 17


[newport_xps_q8]
ip_address = 192.168.192.117
port = 5001
timeout = 20

[motor_FPM_X]
group_name = FPM_X
positioner_name = ${group_name}.Pos
nominal = 8.605

[motor_FPM_Y]
group_name = FPM_Y
positioner_name = ${group_name}.Pos
coron_bias140 = 10.251
coron_flat = 10.251
default_coron = ${coron_flat}
direct = 9
nominal = ${default_coron}

[motor_lyot_stop_x]
group_name = Lyot_X
positioner_name = ${group_name}.Pos
in_beam = 2.545

; HARDWARE SAFETY - Do not modify out_of_beam, it could hit the FPM.
out_of_beam = 50
nominal = ${in_beam}

[motor_lyot_stop_y]
group_name = Lyot_Y
positioner_name = ${group_name}.Pos
nominal = 10.32

[motor_lyot_stop_z]
group_name = Lyot_Z
positioner_name = ${group_name}.Pos
nominal = 9.5

[motor_lyot_stop_theta]
group_name = Lyot_Theta
positioner_name = ${group_name}.Pos
nominal = -181.147

[motor_img_camera]
group_name = Img_Camera
positioner_name = ${group_name}.Pos
nominal = 11.37

[motor_phase_camera]
group_name = PR_Camera
positioner_name = ${group_name}.Pos
nominal = ${flat_map_position}
bias_position = -1.31
flat_map_position = -1.31
min = -60
max = 80

[npoint_tiptilt_lc_400]
vendor_id = 1027
product_id = 24596

; The following flip mounts are Thorlabs model MFF101_1
[beam_dump_flip_mount]
; Imaging beam dump for background exposures
serial = 37000085
in_beam_position = 1
out_of_beam_position = 2

[phase_retrieval_mirror_flip_mount]
; Flip mount for PR mirror
serial = 37001725
in_beam_position = 1
out_of_beam_position = 2

[nd_filter_flip_mount]
; Flip mount for ND filter prior to imaging cam
; Distinct from ND filters on the filterwheel!
serial = 37873863
in_beam_position = 1
out_of_beam_position = 2

[fpm_illuminator]
; Flip mount to illuminate FPM with diffuse light
serial = 37871220
in_beam_position = 2
out_of_beam_position = 1

[pupil_illuminator]
; Flip mount to illuminate pupil with diffuse light
serial = 37002369
in_beam_position = 2
out_of_beam_position = 1

[thorlabs_source_mcls1]
lambda_nm = 638
nominal_current = 52
coron_current = 52
direct_current = 52
channel = 2
device_id = \Device\VCP0
use_dummy = true
flux_current_slope = 794.5235
flux_current_yint = -38103.0884

[omega_ithx_w3_2]
ip = 192.168.192.132

[thorlabs_tsp01_2]
serial_number = M00542273

[thorlabs_tsp01_1]
serial_number = M001546345

[optical_design]
; focal_length1 = xxx
; focal_length2 = xxx
; focal_length3 = xxx
; focal_legth4 = xxx
; focal_length5 = xxx
focal_length6 = 0.478
focal_length7 = 0.209
; focal_length8 = xxx
; focal_length9 = xxx
; focal_length10 = xxx

[4d_accufiz]
ip = 192.168.192.131
timeout = 1900000
central_store_path = ${optics_lab:data_path}

[thorlabs_fw102c_1]
mac_resource_name = ASRL/dev/cu.usbserial-TP01517280-7417::INSTR
windows_resource_name = ASRLCOM4::INSTR
; Filter names should start with "filter_", and positions are integers.
filter_610nm = 1
filter_620nm = 2
filter_640nm = 3
filter_660nm = 4
filter_670nm = 5
filter_broadband = 6

[thorlabs_fw102c_2]
mac_resource_name = ASRL/dev/cu.usbserial-TP02208445-15840::INSTR
windows_resource_name = ASRLCOM6::INSTR

; Filter names should start with "filter_", and positions are integers.
filter_clear_1 = 1
filter_26_percent = 2
filter_12_percent = 3
filter_9_percent = 4
filter_clear_2 = 5
filter_clear_3 = 6

[light_source_assembly]
; Since we can't actually control the light source, set use_dummy to true.
use_dummy = true

[data_pipeline]
std_dev_data_quality_map = 3
size_filter_bad_pixel = 3

; reference image for global alignment cross correlation option.
; path is relative to the hicat package directory
; ONLY USED IN APLC MODE!
simulated_reference_image_filename = simulators/centering_ref_images/sim_coron_aplc_v2.fits
hardware_reference_image_filename = simulators/centering_ref_images/measured_coron_aplc_v2.fits

[data_simulator]
; path of where we export the file - maybe should be a parameter?
output_folder=Output
; path of where the DM command lives - maybe shoudl be a parameter?
input_folder=Input
; size of the array used to represent the DM - about 500 seems a good compromize. This is calculated from apodizer size
n_pixel_dm=554

; parameters for wavefront error simulation, including polishing errors (as a power spectrum) and low-order Zernike terms
power_spectrum_phase_slope=3
power_spectrum_rms_nm=25
power_spectrum_random_seed = None
wfe_tilt_nm=0
wfe_focus_nm=0
wfe_astig_nm=20
wfe_coma_nm=20
wfe_trefoil_nm=20

; WFE file, alternative to Zernikes above
; located in hicat/simulators/input_data_files
residual_wfe_filename = phase_out_zernike.fits

; cnt1b apodizer, no iris-ao June 21 , 2019
; uncertainty on this number comes from uncertainty on MTF support threshold: 12.60 +/- 0.02
; NOTE: this is the sampling for a perfect circular aperture of equivalent area in the MTF plane to the apodizer MTF
; So this is an AVERAGE sampling over all directions.
;sampling_with_lyot_stop = 12.69

; no apodizer, no iris-ao February 26 , 2019
;sampling_with_lyot_stop= 13.131
; \[Lambda]/D, Based on HiCAT_APLCSP_spreadsheet_v08.xlsx the diameter is 8.688 \[Lambda]/DapodAtDM1

; no apodizer, no iris-ao April 17, 2020 - "CLC2" mode with pupil and LS that match the sizes in APLC mode
sampling_with_lyot_stop = 12.5456

; standard deviation in pixels for the actuator shape - we can try to carlibrate that (low prioirty for now)
std_dev_actuator_size=1.5
; This needs to be calibrated based on the satellite spots contrast
height_actuator_bumps_nm=20


; field_of_view_oversize to be used in case data acquisition is larger than the control region e.g. for COFFEE using 1424 vs. 712 and simulator does not need to calculate the full field of view
field_of_view_oversize = 1

; flux correction factor for use in hicat_sim. poppy normalizes PSFs to entrance pupil=1 by default, but
; in the APLC case the entrance pupil is the oversized circle, vs. the direct photometry which is measured on
; the APLC aperture. So we need to correct for that.
simulator_direct_exit_vs_entrance_pupil_flux = 0.64361

; "Fudge factor" empirical scale correction to better match simulator pixel scales to observed data pixel scales.
; simulator_imaging_camera_pixelscale_adjustment = 1.022
simulator_imaging_camera_pixelscale_adjustment = 0.975
simulator_pupil_camera_pixelscale_adjustment = 1.0

[speckle_nulling]
dark_zone_minimum_intensity = 2000
dark_zone_maximum_intensity = 20000
dark_zone_autoexp_min = 2000
dark_zone_autoexp_max = 20000
direct_psf_aperture_photometry_cts_per_microsec = 80407
direct_psf_total_photometry_counts_per_microsec = 103103
global_alignment_mask_radius = 210

[photometry]
; these values are implicitly dependent on a particular light source, and on the laser power, neither of which are
; recorded here
default_exposure_time_simulator_microsec = 1000
; photometry in image plane:
total_direct_photometry_cts_per_microsec = 127084
; and photometry in pupil plane:
total_pupil_direct_photometry_cts_per_microsec = 259000
lambdaoverDLyotStop_direct_photometry_cts_per_microsec = 54549
max_psf_cal_cts_per_microsec = 635
max_psf_bin_cts_per_microsec = 9119

[cross_correlation]
subpixel_upsample_factor = 3

[blue_ups]
ip = 10.128.242.6
port = 161
snmp_oid = 1.3.6.1.4.1.534.1.3.5.0
community = palapa
pass_status = 3

[lab_ups]
ip = 192.168.192.20
port = 161
snmp_oid = .1.3.6.1.4.1.318.1.1.1.4.1.1.0
community = public
pass_status = 2

[web_power_switch]
user = admin
password = hicat
ip = 192.168.192.11
dns = webpowerswitch
; "all_off" and "all_on" values correspond to a line number of the Script listing (http://192.168.192.11/script.htm).
all_off = 34
all_on = 36
; Add devices plugged into power switch here, along with the outlet number.
npoint_tiptilt_lc_400 = 1
omega_ithx_w3_2 = 2
newport_xps_q8 = 3
iris_dm = 4
quad_cell = 5
air_valve = 6
pupil_led = 7
fpm_led = 8

[nws]
; National Weather Service feed for warnings
; list of warnings that will trigger a shutdown
wx_warning_list = ["Tornado Warning","Severe Thunderstorm Warning","Severe Weather Statement","Convective Flash Flood Warning","Areal Flood Warning","Extreme Wind Warning","High Wind Warning"]
; feed for Baltimore City.  Any warning in the Baltimore City warning area is considered a HICAT warning.
wx_url=http://alerts.weather.gov/cap/wwaatmget.php?x=MDC510


[safety]
min_humidity = 1
max_humidity = 28
; "temp" is in celcius.
min_temp = 0
max_temp = 29
; "check_interval" is in seconds.
check_interval = 60

[cnt2_apodizer]
; These coordinates should be obtained from DS9 and are y,x as read in DS9.
centering_spot1 = 55,663
centering_spot2 = 667,52
diameter = 19.725

; This is the first speckle in a line, good for non saturated images.
;centering_spot1 = 577,491
;centering_spot2 = 133,227

[cnt1_apodizer]
; These coordinates should be obtained from DS9 and are y,x as read in DS9.
; Nominal apodizer diameter in mm.
centering_spot1 = 660,665
centering_spot2 = 52,60
diameter = 19.725

[cnt1b_apodizer]
; These coordinates should be obtained from DS9 and are y,x as read in DS9.
; Nominal apodizer diameter in mm, not including compression factor in x-axis.
centering_spot1 = 144,64
centering_spot2 = 569,657
diameter = 19.725

[no_apodizer]
; These coordinates should be obtained from DS9 and are y,x as read in DS9.
centering_spot1 = 352,658
centering_spot2 = 353,45
diameter = none

[no_apodizer_iris_ao]
; These coordinates should be obtained from DS9 and are y,x as read in DS9.
centering_spot1 = 718,407
centering_spot2 = 717,1011
diameter = none

[calibration]
auto_focus_start_position = 7.0
auto_focus_end_position = 14.0
auto_focus_position_step_size = 0.1
auto_focus_mtf_snr_thrshold = 100
sampling_mtf_snr_thrshold = 17
;auto_expose_cache_lifetime has units seconds. <=0 => non-volatile
auto_expose_cache_lifetime = 0

; exposure times for empirical flux normalization in microseconds
; explanation how we get them: https://github.com/spacetelescope/hicat-package/pull/234#issuecomment-601329263
; this will be revisited in HICAT-765
flux_norm_exp_time_direct_clc = 228750
flux_norm_exp_time_direct_aplc = 4405

[apodizer_picomotor]
ip_address = 192.168.192.151
max_step = 2147483647
timeout = 60
daisy = 0
motor_x = 1
motor_y = 2
sleep_per_step = 0.0005

[quad_cell_picomotor]
ip_address = 192.168.192.151
max_step = 2147483647
timeout = 60
motor_x = 3
motor_y = 4
daisy = 0
sleep_per_step = 0.0005

[target_acquisition]
ta_center =  1164, 487
sci_center = 1741, 1207
; % of counts inside radial cut
ta_profile_threshold = 0.5
sci_profile_threshold = 0.5
; exposure time in us
ta_exposure_time = 500
sci_exposure_time = 500
;pixel/steps ratios
apodizer_to_ta_pixels_per_step_ratio = -0.5733, -0.6733
apodizer_to_sci_pixels_per_step_ratio = -0.1666, -0.1983
quad_cell_to_ta_pixels_per_step_ratio = 0, 0
;number of steps to calibrate pixels/step ratio with
apodizer_to_ta_calibration_steps = 50
apodizer_to_sci_calibration_steps = 100
quad_cell_to_ta_calibration_steps = 100
;centroid methods
ta_centroid_method = 1d
sci_centroid_method = 2d
; TA takes images over a time period and sleeps between exposures to negate turbulance.
; There is an runtime overhead in the image acquisition that needs to be accounted for to accurately expose within
; this desired exposure period. This overhead is that below and is per single image (units = seconds).
image_capture_over_head_time = 0.175

[testbed]
safety_temperature_sensor = omega_ithx_w3_2
aux_temperature_sensor = thorlabs_tsp01_2
imaging_camera = zwo_ASI178MM_3
pupil_camera = zwo_ASI178MM_4
phase_retrieval_camera = zwo_ASI1600MM
;laser_source = thorlabs_source_mcls1
laser_source = light_source_assembly
target_acquisition_camera = zwo_ASI290MM_1
color_wheel = thorlabs_fw102c_1
nd_wheel = thorlabs_fw102c_2

; first attempt to list a complete state for the masks
; note that the pupil and lyot stop diameters are irrelevant if CNT is used
;pupil_mask = not_used
pupil_mask = circular
pupil_diameter = 19.568
iris_ao = not_iris_ao
apodizer = no_apodizer
;apodizer = cnt1b_apodizer
;apodizer = cnt1_apodizer
; \[Lambda]/D_apod, Based on HiCAT_APLCSP_spreadsheet_v08.xlsx the diameter is 8.543 \[Lambda]/DapodAtDM1
; fpm diameter for 19.568 mm CLC2 circular pupil is 8.555 lambda/d_pupil as measured by TA camera; see HICAT-875 on JIRA
fpm_diam=8.555
;lyot_stop = cnt1_apodizer_lyot_stop
lyot_stop = circular
lyot_stop_diameter = 15.9
